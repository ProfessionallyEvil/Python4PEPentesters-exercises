import string
import random
import cherrypy


class TwoStageAuth(object):
    nonces = {}
    pusername = None
    ppassword = None

    @cherrypy.expose
    def index(self):
        self.init_pusers()
        return """<html><head><title>Tricky Auth</title></head>
        <body><h2>Welcome to some tricky auth... dare to login if ye can!</h2></b>
        <p><form method="post" action="/password">
        Username: <input type="text" name="username"><br>
        <input type="submit" value="Submit">
        </p>
        </body>
        </html>"""

    @cherrypy.expose
    def password(self, username):
        if username == self.pusername:
            nonce = ''.join(random.sample(string.hexdigits, 20))
            self.nonces[username] = nonce
            return """<html><head><title>Tricky Auth</title></head>
            <body><h2>So far so good... now how about the password?</h2>
            <p><form method="post" action="/login">
            Password: <input type="password" name="password"><br>
            <input type="hidden" name="username" value="%s">
            <input type="hidden" name="nonce" value="%s">
            <input type="submit" value="Submit">
            </p>
            </body>
            </html>
            """ % (username, nonce)
        else:
            print ("missmatch between %s and %s" % (username, self.pusername))
            return self.index()

    @cherrypy.expose
    def login(self, password, username, nonce):
        try:
            noncecheck = self.nonces.pop(username)
            if noncecheck == nonce:
                if password == self.ppassword:
                    return "<html><h1>Aye, that's right!  The treasure be yers!</h1></html>"
                else:
                    return "<html><h2>Nay, that be the wrong password.  <a href='/index/'>Try again</a></html></body>"
            else:
                return self.cheater()
        except KeyError:
            return self.cheater()


    def cheater(self):
        return "<html><body>Sorry matey, ye be caught cheating!  <a href='/index/'>Try again</a></html></body>"

    def init_pusers(self):
        if self.pusername is None:
            userfile = open('names.txt')
            users = userfile.readlines()
            self.pusername = random.choice(users).strip()
            userfile.close()
            passwordfile = open('passwords.txt')
            passwords = passwordfile.readlines()
            self.ppassword = random.choice(passwords).strip()
            passwordfile.close()
            #print "credentials are: %s / %s" % (self.pusername, self.ppassword)

if __name__ == '__main__':
    cherrypy.config.update({'server.socket_host': '127.0.0.1', 'server.socket_port': 9942, })
    app = TwoStageAuth()
    cherrypy.quickstart(app)